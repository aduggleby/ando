@model Ando.Server.ViewModels.ProjectDetailsViewModel
@{
    ViewData["Title"] = Model.RepoFullName;
}

<div class="page-header">
    <div class="breadcrumb">
        <a href="/projects">Projects</a> / <span>@Model.RepoFullName</span>
    </div>
    <div class="header-actions">
        @if (Model.IsConfigured)
        {
            <form method="post" action="/projects/@Model.Id/build" class="inline-form">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-primary">Trigger Build</button>
            </form>
        }
        else
        {
            <button type="button" class="btn btn-primary" disabled title="Configure required secrets first">Trigger Build</button>
        }
        <a href="/projects/@Model.Id/settings" class="btn btn-secondary">Settings</a>
        <a href="@Model.RepoUrl" target="_blank" class="btn btn-secondary">GitHub</a>
    </div>
</div>

@if (!Model.IsConfigured)
{
    <div class="alert alert-warning">
        <strong>Configuration Required</strong>
        <p>This project is missing required secrets: <code>@string.Join("</code>, <code>", Model.MissingSecrets)</code></p>
        <p>Builds cannot run until all required secrets are configured. <a href="/projects/@Model.Id/settings">Go to Settings</a></p>
    </div>
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-error">@TempData["Error"]</div>
}

<div class="project-info">
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">Default Branch</span>
                <span class="info-value">@Model.DefaultBranch</span>
            </div>
            <div class="info-item">
                <span class="info-label">Branch Filter</span>
                <span class="info-value">@(string.IsNullOrEmpty(Model.BranchFilter) ? "All branches" : Model.BranchFilter)</span>
            </div>
            <div class="info-item">
                <span class="info-label">Build Profile</span>
                <span class="info-value">@(string.IsNullOrEmpty(Model.Profile) ? "Default" : Model.Profile)</span>
            </div>
            <div class="info-item">
                <span class="info-label">PR Builds</span>
                <span class="info-value">@(Model.EnablePrBuilds ? "Enabled" : "Disabled")</span>
            </div>
            <div class="info-item">
                <span class="info-label">Timeout</span>
                <span class="info-value">@Model.TimeoutMinutes minutes</span>
            </div>
        <div class="info-item">
            <span class="info-label">Total Builds</span>
            <span class="info-value">@Model.TotalBuilds</span>
        </div>
        <div class="info-item">
            <span class="info-label">Created</span>
            <span class="info-value">@Model.CreatedAt.ToString("MMM d, yyyy")</span>
        </div>
    </div>
</div>

<div class="section">
    <h2>Recent Builds</h2>

    @if (Model.RecentBuilds.Count == 0)
    {
        <div class="empty-state">
            <p>No builds yet. Trigger a manual build or push to the repository.</p>
        </div>
    }
    else
    {
        <table class="builds-table">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Commit</th>
                    <th>Branch</th>
                    <th>Message</th>
                    <th>Trigger</th>
                    <th>Duration</th>
                    <th>Queued</th>
                    <th><span class="sr-only">Actions</span></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var build in Model.RecentBuilds)
                {
                    <tr class="build-row" onclick="window.location='/builds/@build.Id'">
                        <td>
                            <span class="status-badge status-@build.Status.ToString().ToLower()">
                                @build.Status
                            </span>
                        </td>
                        <td>
                            <code class="commit-sha">@build.ShortCommitSha</code>
                        </td>
                        <td>
                            <span class="branch-name">@build.Branch</span>
                            @if (build.PullRequestNumber.HasValue)
                            {
                                <span class="pr-badge">#@build.PullRequestNumber</span>
                            }
                        </td>
                        <td class="commit-message">
                            @(build.CommitMessage?.Length > 60 ? build.CommitMessage[..57] + "..." : build.CommitMessage)
                        </td>
                        <td>@build.Trigger</td>
                        <td>@FormatDuration(build.Duration)</td>
                        <td>@FormatRelativeTime(build.QueuedAt)</td>
                        <td><a href="/builds/@build.Id" class="build-view-link" onclick="event.stopPropagation()">View</a></td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@functions {
    string FormatDuration(TimeSpan? duration)
    {
        if (!duration.HasValue) return "-";

        var d = duration.Value;
        if (d.TotalSeconds < 60) return $"{d.Seconds}s";
        if (d.TotalMinutes < 60) return $"{d.Minutes}m {d.Seconds}s";
        return $"{(int)d.TotalHours}h {d.Minutes}m";
    }

    string FormatRelativeTime(DateTime dateTime)
    {
        var diff = DateTime.UtcNow - dateTime;

        if (diff.TotalMinutes < 1) return "just now";
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7) return $"{(int)diff.TotalDays}d ago";

        return dateTime.ToString("MMM d");
    }
}
