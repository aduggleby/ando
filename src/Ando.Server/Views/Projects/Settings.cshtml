@model Ando.Server.ViewModels.ProjectSettingsViewModel
@{
    ViewData["Title"] = $"Settings - {Model.RepoFullName}";
}

<div class="page-header">
    <div class="breadcrumb">
        <a href="/projects">Projects</a> /
        <a href="/projects/@Model.Id">@Model.RepoFullName</a> /
        <span>Settings</span>
    </div>
</div>

<!-- Sticky save bar (hidden until changes are made) -->
<div id="unsaved-bar" class="unsaved-bar" style="display: none;">
    <span class="unsaved-text">You have unsaved changes</span>
    <div class="unsaved-actions">
        <button type="button" class="btn btn-secondary btn-sm" onclick="discardChanges()">Discard</button>
        <button type="submit" form="settings-form" class="btn btn-primary btn-sm">Save Changes</button>
    </div>
</div>

@if (!Model.IsProfileValid)
{
    <div class="alert alert-error">
        <strong>Invalid Profile</strong>
        <p>The selected profile <code>@Model.Profile</code> no longer exists in this repository's build.csando file.</p>
        <p>Builds will not run until a valid profile is selected or the profile setting is cleared.</p>
    </div>
}

@if (Model.MissingSecrets.Count > 0)
{
    <div class="alert alert-warning">
        <strong>Configuration Required</strong>
        <p>This project is missing required secrets: <code>@string.Join("</code>, <code>", Model.MissingSecrets)</code></p>
        <p>Builds will not run until all required secrets are configured.</p>
    </div>
}

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-error">@TempData["Error"]</div>
}

<div class="settings-container">
    <!-- Build Settings -->
    <div class="settings-section">
        <h2>Build Settings</h2>

        <form id="settings-form" method="post" action="/projects/@Model.Id/settings" data-track-changes="true">
            @Html.AntiForgeryToken()

            <div class="form-group">
                <label for="branchFilter">Branch Filter</label>
                <input type="text" id="branchFilter" name="branchFilter" value="@Model.BranchFilter"
                       placeholder="main,master,develop" />
                <span class="form-hint">Comma-separated list of branches to build. Leave empty to build all branches.</span>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="enablePrBuilds" value="true" @(Model.EnablePrBuilds ? "checked" : "") />
                    <span>Enable Pull Request Builds</span>
                </label>
                <span class="form-hint">Build pull requests targeting the filtered branches.</span>
            </div>

            <div class="form-group">
                <label for="timeoutMinutes">Build Timeout (minutes)</label>
                <input type="number" id="timeoutMinutes" name="timeoutMinutes" value="@Model.TimeoutMinutes"
                       min="1" max="60" />
                <span class="form-hint">Maximum time for a build before it's cancelled (1-60 minutes).</span>
            </div>

            <div class="form-group">
                <label for="dockerImage">Docker Image (optional)</label>
                <input type="text" id="dockerImage" name="dockerImage" value="@Model.DockerImage"
                       placeholder="mcr.microsoft.com/dotnet/sdk:10.0-alpine" />
                <span class="form-hint">Custom Docker image for builds. Leave empty to use the default.</span>
            </div>

            <div class="form-group">
                <label for="profile">Build Profile</label>
                @if (Model.AvailableProfiles.Count > 0)
                {
                    <select id="profile" name="profile" class="@(!Model.IsProfileValid ? "input-error" : "")">
                        <option value="">None (default build)</option>
                        @foreach (var profile in Model.AvailableProfiles)
                        {
                            var isSelected = Model.Profile == profile;
                            <option value="@profile" selected="@isSelected">@profile</option>
                        }
                    </select>
                    <span class="form-hint">
                        Select a build profile to run. Profiles are defined with <code>DefineProfile("name")</code> in your build.csando file.
                    </span>
                }
                else
                {
                    <select id="profile" name="profile" disabled>
                        <option value="">No profiles available</option>
                    </select>
                    <span class="form-hint">
                        No profiles detected. Add <code>DefineProfile("name")</code> to your build.csando to enable profile selection.
                    </span>
                }
            </div>

            <div class="form-group">
                <div class="flex items-center justify-between">
                    <label>Detected Required Secrets</label>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="refreshSecrets()">Refresh</button>
                </div>
                @if (!string.IsNullOrEmpty(Model.RequiredSecrets))
                {
                    <div class="detected-secrets">
                        @foreach (var secret in Model.RequiredSecrets.Split(',', StringSplitOptions.TrimEntries | StringSplitOptions.RemoveEmptyEntries))
                        {
                            <code class="secret-tag">@secret</code>
                        }
                    </div>
                    <span class="form-hint">These environment variables were automatically detected from your build.csando file. Configure them in the Secrets section below.</span>
                }
                else
                {
                    <p class="empty-message mt-2">No required secrets detected in build.csando.</p>
                    <span class="form-hint">Environment variables used via <code>Env("VAR_NAME")</code> in your build script will appear here.</span>
                }
            </div>

            <h3>Notifications</h3>

            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="notifyOnFailure" value="true" @(Model.NotifyOnFailure ? "checked" : "") />
                    <span>Notify on Build Failure</span>
                </label>
            </div>

            <div class="form-group">
                <label for="notificationEmail">Notification Email</label>
                <input type="email" id="notificationEmail" name="notificationEmail" value="@Model.NotificationEmail"
                       placeholder="builds@example.com" />
                <span class="form-hint">Email address to receive failure notifications.</span>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Save Settings</button>
            </div>
        </form>
    </div>

    <!-- Secrets -->
    <div class="settings-section">
        <h2>Secrets</h2>
        <p class="section-description">
            Environment variables that will be available during builds.
            Secrets cannot be viewed once saved.
        </p>

        @if (Model.SecretNames.Count > 0)
        {
            <div class="secrets-list">
                @foreach (var name in Model.SecretNames)
                {
                    <div class="secret-row">
                        <code class="secret-name">@name</code>
                        <button type="button" class="btn-icon" onclick="copySecretName('@name')" title="Copy name">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                        </button>
                        <span class="secret-value-masked">••••••••••••</span>
                        <form method="post" action="/projects/@Model.Id/secrets/@name/delete" class="inline-form"
                              onsubmit="return confirm('Delete secret @name?');">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn-icon btn-icon-danger" title="Delete secret">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </form>
                    </div>
                }
            </div>
        }
        else
        {
            <p class="empty-message">No secrets configured.</p>
        }

        <h3>Add Secret</h3>
        <form method="post" action="/projects/@Model.Id/secrets" class="add-secret-form">
            @Html.AntiForgeryToken()

            <div class="form-row">
                <div class="form-group">
                    <label for="secretName">Name</label>
                    <input type="text" id="secretName" name="name" placeholder="MY_SECRET"
                           pattern="^[A-Z_][A-Z0-9_]*$" required
                           oninput="formatSecretName(this)" />
                    <span class="form-hint format-helper">Use UPPERCASE_WITH_UNDERSCORES</span>
                </div>
                <div class="form-group flex-grow">
                    <label for="secretValue">Value</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="secretValue" name="value" placeholder="secret value" required />
                        <button type="button" class="btn-icon password-toggle" onclick="toggleSecretVisibility()" title="Show/hide">
                            <svg id="eye-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                            <svg id="eye-off-icon" class="w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="form-group form-button">
                    <button type="submit" class="btn btn-primary">Add</button>
                </div>
            </div>
        </form>

        <h3 class="mt-8">Bulk Import</h3>
        <p class="section-description">
            Upload a .env file or paste content to import multiple secrets at once.
            Existing secrets with matching names will be updated.
        </p>

        <div class="form-group">
            <label for="envFileUpload">Upload .env file</label>
            <div class="file-upload-wrapper">
                <input type="file" id="envFileUpload" accept=".env,.txt" onchange="loadEnvFile(this)" />
                <span class="form-hint">Select a .env file to load its contents into the text area below.</span>
            </div>
        </div>

        <form method="post" action="/projects/@Model.Id/secrets/bulk" class="bulk-import-form">
            @Html.AntiForgeryToken()
            <div class="form-group">
                <label for="bulkContent">Or paste .env content</label>
                <textarea id="bulkContent" name="content" rows="6"
                          placeholder="# Paste .env content here&#10;NUGET_API_KEY=your-api-key&#10;DEPLOY_TOKEN=your-token&#10;DATABASE_URL=&quot;connection-string&quot;"></textarea>
                <span class="form-hint">
                    Format: KEY=value (one per line). Lines starting with # are ignored.
                    Values can be quoted with single or double quotes.
                </span>
            </div>
            <button type="submit" class="btn btn-secondary">Import Secrets</button>
        </form>
    </div>

    <!-- Danger Zone -->
    <div class="settings-section danger-zone">
        <h2>Danger Zone</h2>

        <div class="danger-item">
            <div class="danger-info">
                <h3>Delete Project</h3>
                <p>Permanently delete this project and all its builds, logs, and artifacts.</p>
            </div>
            <form method="post" action="/projects/@Model.Id/delete"
                  onsubmit="return confirm('Are you sure you want to delete this project? This action cannot be undone.');">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-danger">Delete Project</button>
            </form>
        </div>
    </div>
</div>

<script>
// Track form changes for unsaved warning
let originalFormData = null;
let hasUnsavedChanges = false;

document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('settings-form');
    if (form) {
        originalFormData = new FormData(form);

        form.addEventListener('input', checkForChanges);
        form.addEventListener('change', checkForChanges);
    }
});

function checkForChanges() {
    const form = document.getElementById('settings-form');
    const currentData = new FormData(form);
    let changed = false;

    for (const [key, value] of currentData.entries()) {
        if (key === '__RequestVerificationToken') continue;
        const original = originalFormData.get(key) || '';
        if (value !== original) {
            changed = true;
            break;
        }
    }

    hasUnsavedChanges = changed;
    document.getElementById('unsaved-bar').style.display = changed ? 'flex' : 'none';
}

function discardChanges() {
    const form = document.getElementById('settings-form');
    form.reset();

    // Reset checkboxes to original values
    for (const [key, value] of originalFormData.entries()) {
        const input = form.querySelector(`[name="${key}"]`);
        if (input && input.type === 'checkbox') {
            input.checked = value === 'true';
        }
    }

    hasUnsavedChanges = false;
    document.getElementById('unsaved-bar').style.display = 'none';
}

// Warn before leaving with unsaved changes
window.addEventListener('beforeunload', (e) => {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// Secret visibility toggle
function toggleSecretVisibility() {
    const input = document.getElementById('secretValue');
    const eyeIcon = document.getElementById('eye-icon');
    const eyeOffIcon = document.getElementById('eye-off-icon');

    if (input.type === 'password') {
        input.type = 'text';
        eyeIcon.classList.add('hidden');
        eyeOffIcon.classList.remove('hidden');
    } else {
        input.type = 'password';
        eyeIcon.classList.remove('hidden');
        eyeOffIcon.classList.add('hidden');
    }
}

// Copy secret name to clipboard
async function copySecretName(name) {
    try {
        await navigator.clipboard.writeText(name);
        // Show brief feedback
        const btn = event.currentTarget;
        btn.classList.add('text-success');
        setTimeout(() => btn.classList.remove('text-success'), 1000);
    } catch (err) {
        console.error('Failed to copy:', err);
    }
}

// Auto-format secret name to uppercase with underscores
function formatSecretName(input) {
    const value = input.value;
    const formatted = value.toUpperCase().replace(/[^A-Z0-9_]/g, '_').replace(/^[0-9]/, '_$&');
    if (formatted !== value) {
        input.value = formatted;
    }
}

// Refresh detected secrets
function refreshSecrets() {
    document.getElementById('refresh-secrets-form').submit();
}

// Load .env file contents into the bulk import textarea
function loadEnvFile(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const textarea = document.getElementById('bulkContent');
        if (textarea) {
            textarea.value = e.target.result;
            // Highlight the textarea to show it was populated
            textarea.focus();
            textarea.classList.add('file-loaded');
            setTimeout(() => textarea.classList.remove('file-loaded'), 2000);
        }
    };
    reader.onerror = function() {
        alert('Failed to read file. Please try again or paste the content manually.');
    };
    reader.readAsText(file);
}
</script>

<!-- Hidden form for refresh secrets (outside the main settings form to avoid nesting) -->
<form id="refresh-secrets-form" method="post" action="/projects/@Model.Id/refresh-secrets" style="display: none;">
    @Html.AntiForgeryToken()
</form>
