---
import BaseLayout from "../../layouts/BaseLayout.astro";
import CodeBlock from "../../components/CodeBlock.astro";

const buildCode = `// Create a directory reference for the website project.
var website = Directory(".");

// Install Node.js (includes npm) in the Ubuntu container.
Node.Install();

// Install dependencies.
Npm.Install(website);

// Build the Astro site (outputs to ./dist).
Npm.Build(website);

// Verify Cloudflare authentication.
Cloudflare.EnsureAuthenticated();

// Deploy to Cloudflare Pages.
Cloudflare.PagesDeploy(website / "dist", "my-site");

// Purge the Cloudflare cache to ensure visitors see the latest content.
Cloudflare.PurgeCache("example.com");`;
---

<BaseLayout
  title="Astro Example - ANDO"
  description="Build and deploy an Astro site to Cloudflare Pages with ANDO."
  alternateMarkdownUrl="/examples/astro.md"
>
  <div class="max-w-3xl">
    <section id="top" class="mb-8 md:mb-12">
      <div class="mb-4">
        <a
          href="/examples"
          class="text-sm text-zinc-500 hover:text-cyan-600 dark:text-zinc-400 dark:hover:text-cyan-400"
          >&larr; All Examples</a
        >
      </div>
      <h1 class="mb-2 text-2xl font-bold text-zinc-900 sm:text-3xl dark:text-white">Astro + Cloudflare Pages</h1>
      <p class="text-zinc-500 dark:text-zinc-400">
        Build an Astro site and deploy it to Cloudflare Pages with cache purging.
      </p>
    </section>

    <section class="mb-10">
      <h2 class="mb-3 text-xl font-bold text-zinc-900 dark:text-white">Overview</h2>
      <p class="mb-4 text-zinc-600 dark:text-zinc-400">
        This example demonstrates a complete workflow for building and deploying a static Astro website to Cloudflare
        Pages. The build runs in an Ubuntu container with Node.js installed automatically.
      </p>
      <p class="text-zinc-600 dark:text-zinc-400">The workflow performs these steps:</p>
      <ol class="mt-3 list-inside list-decimal space-y-2 text-zinc-600 dark:text-zinc-400">
        <li>Installs Node.js in the container</li>
        <li>Installs npm dependencies</li>
        <li>Builds the Astro site</li>
        <li>Authenticates with Cloudflare</li>
        <li>Deploys to Cloudflare Pages</li>
        <li>Purges the Cloudflare cache so visitors see the latest content</li>
      </ol>
    </section>

    <section class="mb-10">
      <h2 class="mb-3 text-xl font-bold text-zinc-900 dark:text-white">Build Script</h2>
      <CodeBlock code={buildCode} lang="csharp" filename="build.csando" />
    </section>

    <section class="mb-10">
      <h2 class="mb-3 text-xl font-bold text-zinc-900 dark:text-white">Prerequisites</h2>
      <ul class="list-inside list-disc space-y-2 text-zinc-600 dark:text-zinc-400">
        <li>
          <code class="rounded bg-zinc-100 px-1.5 text-sm dark:bg-zinc-800">CLOUDFLARE_API_TOKEN</code> environment variable
          (or enter when prompted)
        </li>
        <li>
          <code class="rounded bg-zinc-100 px-1.5 text-sm dark:bg-zinc-800">CLOUDFLARE_ACCOUNT_ID</code> environment variable
          (or enter when prompted)
        </li>
        <li>A Cloudflare Pages project already created</li>
      </ul>
    </section>

    <section class="mb-10">
      <h2 class="mb-3 text-xl font-bold text-zinc-900 dark:text-white">Key Operations</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-zinc-200 dark:border-zinc-700">
              <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Operation</th
              >
              <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Purpose</th>
            </tr>
          </thead>
          <tbody>
            <tr class="border-b border-zinc-100 dark:border-zinc-800">
              <td class="px-3 py-3">
                <a href="/providers/node" class="text-cyan-600 hover:underline dark:text-cyan-400">Node.Install()</a>
              </td>
              <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400">Installs Node.js v22 in the container</td>
            </tr>
            <tr class="border-b border-zinc-100 dark:border-zinc-800">
              <td class="px-3 py-3">
                <a href="/providers/npm#install" class="text-cyan-600 hover:underline dark:text-cyan-400"
                  >Npm.Install()</a
                >
              </td>
              <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400"
                >Runs <code class="rounded bg-zinc-100 px-1 text-xs dark:bg-zinc-800">npm install</code> to install dependencies</td
              >
            </tr>
            <tr class="border-b border-zinc-100 dark:border-zinc-800">
              <td class="px-3 py-3">
                <a href="/providers/npm#build" class="text-cyan-600 hover:underline dark:text-cyan-400">Npm.Build()</a>
              </td>
              <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400"
                >Runs <code class="rounded bg-zinc-100 px-1 text-xs dark:bg-zinc-800">npm run build</code> to build the Astro
                site</td
              >
            </tr>
            <tr class="border-b border-zinc-100 dark:border-zinc-800">
              <td class="px-3 py-3">
                <a
                  href="/providers/cloudflare#ensureauthenticated"
                  class="text-cyan-600 hover:underline dark:text-cyan-400">Cloudflare.EnsureAuthenticated()</a
                >
              </td>
              <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400">Verifies Cloudflare credentials are available</td>
            </tr>
            <tr class="border-b border-zinc-100 dark:border-zinc-800">
              <td class="px-3 py-3">
                <a href="/providers/cloudflare#pagesdeploy" class="text-cyan-600 hover:underline dark:text-cyan-400"
                  >Cloudflare.PagesDeploy()</a
                >
              </td>
              <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400"
                >Deploys the <code class="rounded bg-zinc-100 px-1 text-xs dark:bg-zinc-800">dist</code> folder to Cloudflare
                Pages</td
              >
            </tr>
            <tr class="border-b border-zinc-100 dark:border-zinc-800">
              <td class="px-3 py-3">
                <a href="/providers/cloudflare#purgecache" class="text-cyan-600 hover:underline dark:text-cyan-400"
                  >Cloudflare.PurgeCache()</a
                >
              </td>
              <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400"
                >Clears the CDN cache so visitors see the latest content</td
              >
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="mb-10">
      <h2 class="mb-3 text-xl font-bold text-zinc-900 dark:text-white">Running the Build</h2>
      <CodeBlock code="ando" lang="shell" filename="shell" />
      <p class="mt-4 text-zinc-600 dark:text-zinc-400">
        The build runs inside a Docker container. On first run, ANDO will prompt for Cloudflare credentials if the
        environment variables aren't set.
      </p>
    </section>
  </div>
</BaseLayout>
