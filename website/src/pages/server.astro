---
import ProviderLayout from "../layouts/ProviderLayout.astro";
---

<ProviderLayout
  title="CI Server"
  provider="CI Server"
  description="Self-hosted CI/CD server for ANDO build scripts with GitHub integration."
>
  <section id="overview" class="mb-8">
    <h2 class="mb-3 text-xl font-bold text-zinc-900 dark:text-white">Overview</h2>
    <p class="mb-4 text-zinc-500 dark:text-zinc-400">
      The ANDO CI Server is a self-hosted continuous integration server that runs your
      <code class="rounded border border-zinc-200 bg-zinc-100 px-1.5 text-sm dark:border-zinc-700 dark:bg-zinc-800"
        >build.csando</code
      > scripts automatically when you push to GitHub. It provides a web interface for monitoring builds, viewing logs, and
      managing projects.
    </p>

    <div class="mb-6 grid gap-4 md:grid-cols-2">
      <div class="rounded-lg border border-zinc-200 bg-zinc-50 p-4 dark:border-zinc-700 dark:bg-zinc-800">
        <h3 class="mb-2 font-semibold text-zinc-900 dark:text-white">GitHub App Integration</h3>
        <p class="text-sm text-zinc-500 dark:text-zinc-400">
          Installs as a GitHub App for secure access to your repositories. Receives webhooks on push events and reports
          build status back to GitHub.
        </p>
      </div>
      <div class="rounded-lg border border-zinc-200 bg-zinc-50 p-4 dark:border-zinc-700 dark:bg-zinc-800">
        <h3 class="mb-2 font-semibold text-zinc-900 dark:text-white">Rootless Docker</h3>
        <p class="text-sm text-zinc-500 dark:text-zinc-400">
          Runs under rootless Docker for enhanced security. Build containers are isolated and cannot escape to the host
          system.
        </p>
      </div>
      <div class="rounded-lg border border-zinc-200 bg-zinc-50 p-4 dark:border-zinc-700 dark:bg-zinc-800">
        <h3 class="mb-2 font-semibold text-zinc-900 dark:text-white">Automatic HTTPS</h3>
        <p class="text-sm text-zinc-500 dark:text-zinc-400">
          Caddy reverse proxy automatically obtains and renews Let's Encrypt certificates. No manual certificate
          management required.
        </p>
      </div>
      <div class="rounded-lg border border-zinc-200 bg-zinc-50 p-4 dark:border-zinc-700 dark:bg-zinc-800">
        <h3 class="mb-2 font-semibold text-zinc-900 dark:text-white">Email Notifications</h3>
        <p class="text-sm text-zinc-500 dark:text-zinc-400">
          Get notified when builds fail. Supports Resend, Azure Communication Services, and SMTP providers.
        </p>
      </div>
    </div>
  </section>

  <section id="architecture" class="mb-8">
    <h2 class="mb-3 text-xl font-bold text-zinc-900 dark:text-white">Architecture</h2>
    <p class="mb-4 text-zinc-500 dark:text-zinc-400">
      The CI Server runs as a set of containers managed by rootless Docker:
    </p>

    <div
      class="relative overflow-x-auto rounded-xl border border-zinc-800 bg-zinc-900 p-4 font-mono text-sm leading-relaxed"
    >
      <pre
        class="m-0 whitespace-pre"><code class="text-zinc-200">┌─────────────────────────────────────────────────────────┐
│                    <span class="text-cyan-400">Ubuntu Server</span>                        │
│                                                         │
│  ┌──────────────┐                                       │
│  │    <span class="text-amber-500">Caddy</span>     │ ◄─── HTTPS (port 443)                 │
│  │  (on host)   │                                       │
│  └──────┬───────┘                                       │
│         │                                               │
│         ▼ localhost:8080                                │
│  ┌─────────────────────────────────────────────────┐    │
│  │           <span class="text-green-400">Rootless Docker</span> (ando user)           │    │
│  │                                                 │    │
│  │  ┌─────────────────┐    ┌─────────────────┐     │    │
│  │  │  <span class="text-violet-400">ando-server</span>    │───▶│  <span class="text-sky-400">ando-sqlserver</span> │     │    │
│  │  │  (CI Server)    │    │  (SQL Server)   │     │    │
│  │  └────────┬────────┘    └─────────────────┘     │    │
│  │           │                                     │    │
│  │           ▼ Docker socket                       │    │
│  │  ┌─────────────────┐                            │    │
│  │  │  <span class="text-orange-400">Build Container</span>│ ◄─── Spawned per build     │    │
│  │  │  (isolated)     │                            │    │
│  │  └─────────────────┘                            │    │
│  └─────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────┘</code></pre>
    </div>
  </section>

  <section id="setup" class="mb-8">
    <h2 class="mb-3 text-xl font-bold text-zinc-900 dark:text-white">Setup</h2>
    <div class="rounded-lg border border-zinc-200 bg-zinc-50 p-4 dark:border-zinc-700 dark:bg-zinc-800">
      <h3 class="mb-3 text-lg font-semibold text-zinc-900 dark:text-white">Prerequisites</h3>
      <ul class="ml-4 list-disc space-y-2 text-sm text-zinc-500 dark:text-zinc-400">
        <li>A fresh Ubuntu 22.04+ server with SSH access</li>
        <li>
          A domain name pointing to your server's IP address (e.g.,
          <code class="rounded border border-zinc-200 bg-zinc-100 px-1 text-xs dark:border-zinc-600 dark:bg-zinc-700"
            >ci.example.com</code
          >) for HTTPS certificates
        </li>
        <li>
          A GitHub App for webhook integration (see
          <a href="#github-app" class="text-cyan-600 hover:underline dark:text-cyan-400">GitHub App Configuration</a>)
        </li>
      </ul>
    </div>
    <div class="mt-8 rounded-lg border border-zinc-200 bg-zinc-50 p-4 dark:border-zinc-700 dark:bg-zinc-800">
      <h3 class="mb-3 text-lg font-semibold text-zinc-900 dark:text-white">Installation</h3>
      <p class="mb-4 text-zinc-500 dark:text-zinc-400">
        Run the installer from your local machine. It will prompt for configuration values and set up everything
        automatically:
      </p>

      <div
        class="relative overflow-x-auto rounded-xl border border-zinc-800 bg-zinc-900 p-4 font-mono text-sm leading-relaxed"
      >
        <span class="absolute top-3 right-4 text-xs tracking-wider text-zinc-400 uppercase">shell</span>
        <pre
          class="m-0 whitespace-pre"><code class="text-zinc-200">curl -fsSL https://andobuild.com/server-install.sh | bash -s user@your-server-ip</code></pre>
      </div>

      <p class="mt-4 mb-2 text-zinc-500 dark:text-zinc-400">The script will:</p>
      <ol
        class="list-decimal space-y-2 pl-5 text-sm text-zinc-600 marker:text-zinc-400 dark:text-zinc-400 dark:marker:text-zinc-500"
      >
        <li>Prompt for all configuration values (GitHub App credentials, domain, etc.)</li>
        <li>Install Docker (rootless) and Caddy on the remote server</li>
        <li>Pull the Docker image from GitHub Container Registry</li>
        <li>Set up persistent storage for database and build artifacts</li>
        <li>Start all services</li>
      </ol>
    </div>
  </section>

  <section id="github-app" class="mb-8">
    <h2 class="mb-3 text-xl font-bold text-zinc-900 dark:text-white">GitHub App Configuration</h2>
    <p class="mb-4 text-zinc-500 dark:text-zinc-400">
      When creating your GitHub App, configure it with these settings:
    </p>

    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-zinc-200 dark:border-zinc-700">
          <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Setting</th>
          <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Value</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-b border-zinc-100 hover:bg-zinc-50 dark:border-zinc-800 dark:hover:bg-zinc-800/50">
          <td class="px-3 py-3 font-medium">Homepage URL</td>
          <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400"
            ><code class="rounded bg-zinc-100 px-1.5 py-0.5 text-cyan-600 dark:bg-zinc-800 dark:text-cyan-400"
              >https://your-domain.com</code
            ></td
          >
        </tr>
        <tr class="border-b border-zinc-100 hover:bg-zinc-50 dark:border-zinc-800 dark:hover:bg-zinc-800/50">
          <td class="px-3 py-3 font-medium">Callback URL</td>
          <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400"
            ><code class="rounded bg-zinc-100 px-1.5 py-0.5 text-cyan-600 dark:bg-zinc-800 dark:text-cyan-400"
              >https://your-domain.com/auth/github/callback</code
            ></td
          >
        </tr>
        <tr class="border-b border-zinc-100 hover:bg-zinc-50 dark:border-zinc-800 dark:hover:bg-zinc-800/50">
          <td class="px-3 py-3 font-medium">Webhook URL</td>
          <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400"
            ><code class="rounded bg-zinc-100 px-1.5 py-0.5 text-cyan-600 dark:bg-zinc-800 dark:text-cyan-400"
              >https://your-domain.com/webhooks/github</code
            ></td
          >
        </tr>
        <tr class="border-b border-zinc-100 hover:bg-zinc-50 dark:border-zinc-800 dark:hover:bg-zinc-800/50">
          <td class="px-3 py-3 font-medium">Webhook Secret</td>
          <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400">Generate a secure random string</td>
        </tr>
      </tbody>
    </table>

    <h3 class="mt-6 mb-3 font-semibold text-zinc-900 dark:text-white">Required Permissions</h3>
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-zinc-200 dark:border-zinc-700">
          <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Permission</th>
          <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Access</th>
        </tr>
      </thead>
      <tbody>
        <tr class="border-b border-zinc-100 hover:bg-zinc-50 dark:border-zinc-800 dark:hover:bg-zinc-800/50">
          <td class="px-3 py-3">Contents</td>
          <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400">Read</td>
        </tr>
        <tr class="border-b border-zinc-100 hover:bg-zinc-50 dark:border-zinc-800 dark:hover:bg-zinc-800/50">
          <td class="px-3 py-3">Metadata</td>
          <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400">Read</td>
        </tr>
        <tr class="border-b border-zinc-100 hover:bg-zinc-50 dark:border-zinc-800 dark:hover:bg-zinc-800/50">
          <td class="px-3 py-3">Commit statuses</td>
          <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400">Read and write</td>
        </tr>
      </tbody>
    </table>

    <h3 class="mt-6 mb-3 font-semibold text-zinc-900 dark:text-white">Subscribe to Events</h3>
    <ul class="ml-4 list-disc text-sm text-zinc-500 dark:text-zinc-400">
      <li>Push</li>
      <li>Pull request</li>
    </ul>

    <p class="mt-4 text-sm text-zinc-500 dark:text-zinc-400">
      After creating the app, generate and download the private key (.pem file). You'll need the App ID, Client ID,
      Client Secret, Webhook Secret, and private key during installation.
    </p>
  </section>

  <section id="documentation" class="mb-8">
    <h2 class="mb-3 text-xl font-bold text-zinc-900 dark:text-white">Full Documentation</h2>
    <p class="mb-4 text-zinc-500 dark:text-zinc-400">
      For complete documentation including server management, updates, backups, troubleshooting, and developer setup,
      see the README.md file in the repository:
    </p>

    <a
      href="https://github.com/aduggleby/ando/blob/main/src/Ando.Server/README.md"
      class="inline-flex items-center gap-2 rounded-lg border border-zinc-200 bg-zinc-50 px-4 py-3 text-sm font-medium text-zinc-900 transition-colors hover:bg-zinc-100 dark:border-zinc-700 dark:bg-zinc-800 dark:text-white dark:hover:bg-zinc-700"
      target="_blank"
    >
      <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
        <path
          d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
        ></path>
      </svg>
      View README.md on GitHub
    </a>

    <div class="mt-6 grid gap-3 md:grid-cols-2">
      <a
        href="https://github.com/aduggleby/ando/blob/main/src/Ando.Server/README.md#server-management"
        class="rounded-lg border border-zinc-200 p-3 transition-colors hover:bg-zinc-50 dark:border-zinc-700 dark:hover:bg-zinc-800/50"
        target="_blank"
      >
        <h4 class="font-medium text-zinc-900 dark:text-white">Server Management</h4>
        <p class="text-xs text-zinc-500 dark:text-zinc-400">Scripts for logs, restarts, status checks</p>
      </a>
      <a
        href="https://github.com/aduggleby/ando/blob/main/src/Ando.Server/README.md#backup"
        class="rounded-lg border border-zinc-200 p-3 transition-colors hover:bg-zinc-50 dark:border-zinc-700 dark:hover:bg-zinc-800/50"
        target="_blank"
      >
        <h4 class="font-medium text-zinc-900 dark:text-white">Backups</h4>
        <p class="text-xs text-zinc-500 dark:text-zinc-400">Automated daily backups and restore procedures</p>
      </a>
      <a
        href="https://github.com/aduggleby/ando/blob/main/src/Ando.Server/README.md#file-locations"
        class="rounded-lg border border-zinc-200 p-3 transition-colors hover:bg-zinc-50 dark:border-zinc-700 dark:hover:bg-zinc-800/50"
        target="_blank"
      >
        <h4 class="font-medium text-zinc-900 dark:text-white">File Locations</h4>
        <p class="text-xs text-zinc-500 dark:text-zinc-400">Data paths and backup priorities</p>
      </a>
      <a
        href="https://github.com/aduggleby/ando/blob/main/src/Ando.Server/README.md#troubleshooting"
        class="rounded-lg border border-zinc-200 p-3 transition-colors hover:bg-zinc-50 dark:border-zinc-700 dark:hover:bg-zinc-800/50"
        target="_blank"
      >
        <h4 class="font-medium text-zinc-900 dark:text-white">Troubleshooting</h4>
        <p class="text-xs text-zinc-500 dark:text-zinc-400">Common issues and solutions</p>
      </a>
      <a
        href="https://github.com/aduggleby/ando/blob/main/README.md#developer-guide"
        class="rounded-lg border border-zinc-200 p-3 transition-colors hover:bg-zinc-50 dark:border-zinc-700 dark:hover:bg-zinc-800/50"
        target="_blank"
      >
        <h4 class="font-medium text-zinc-900 dark:text-white">Developer Guide</h4>
        <p class="text-xs text-zinc-500 dark:text-zinc-400">Local development setup and building from source</p>
      </a>
      <a
        href="https://github.com/aduggleby/ando/blob/main/src/Ando.Server/README.md#quick-start"
        class="rounded-lg border border-zinc-200 p-3 transition-colors hover:bg-zinc-50 dark:border-zinc-700 dark:hover:bg-zinc-800/50"
        target="_blank"
      >
        <h4 class="font-medium text-zinc-900 dark:text-white">Install Options</h4>
        <p class="text-xs text-zinc-500 dark:text-zinc-400">Local builds, external SQL, and more</p>
      </a>
    </div>
  </section>
</ProviderLayout>
