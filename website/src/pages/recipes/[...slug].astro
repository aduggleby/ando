---
// =============================================================================
// [...slug].astro
//
// Summary: Dynamic route for recipe pages using content collections.
//
// Handles both HTML routes (/recipes/playwright-e2e-tests) and markdown routes
// (/recipes/playwright-e2e-tests.md). The markdown route returns raw markdown
// suitable for LLM consumption.
// =============================================================================

import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { markdownResponse } from "../../lib/markdown";

export async function getStaticPaths() {
  const recipes = await getCollection("recipes");
  const paths = [];

  for (const recipe of recipes) {
    // HTML route: /recipes/playwright-e2e-tests
    paths.push({
      params: { slug: recipe.slug },
      props: { recipe, format: "html" },
    });
    // Markdown route: /recipes/playwright-e2e-tests.md
    paths.push({
      params: { slug: `${recipe.slug}.md` },
      props: { recipe, format: "md" },
    });
  }
  return paths;
}

const { recipe, format } = Astro.props;

if (format === "md") {
  const md = `# ${recipe.data.title}

${recipe.data.description}

[Back to Recipes](/recipes)

${recipe.body}
`;
  return markdownResponse(md);
}

const { Content } = await recipe.render();
const alternateMarkdownUrl = `/recipes/${recipe.slug}.md`;

// Difficulty badge colors
const difficultyColors = {
  beginner: "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400",
  intermediate: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400",
  advanced: "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400",
};
const difficulty = recipe.data.difficulty || "intermediate";
---

<BaseLayout
  title={`${recipe.data.title} - ANDO`}
  description={recipe.data.description}
  alternateMarkdownUrl={alternateMarkdownUrl}
>
  <div class="max-w-3xl">
    <section id="top" class="mb-8 md:mb-12">
      <div class="mb-4">
        <a href="/recipes" class="text-sm text-zinc-500 hover:text-cyan-600 dark:text-zinc-400 dark:hover:text-cyan-400"
          >&larr; All Recipes</a
        >
      </div>
      <div class="mb-2 flex items-center gap-3">
        <h1 class="text-2xl font-bold text-zinc-900 sm:text-3xl dark:text-white">{recipe.data.title}</h1>
        <span class={`rounded-full px-2.5 py-0.5 text-xs font-medium ${difficultyColors[difficulty]}`}>
          {difficulty}
        </span>
      </div>
      <p class="text-zinc-500 dark:text-zinc-400">{recipe.data.description}</p>
    </section>

    <div
      id="content"
      class="prose prose-zinc dark:prose-invert prose-headings:font-semibold prose-a:text-cyan-600 dark:prose-a:text-cyan-400 prose-code:rounded prose-code:bg-zinc-100 prose-code:px-1 prose-code:before:content-none prose-code:after:content-none dark:prose-code:bg-zinc-800 prose-pre:bg-zinc-900 prose-pre:border prose-pre:border-zinc-800 max-w-none"
    >
      <Content />
    </div>
  </div>
</BaseLayout>
