---
import BaseLayout from "../layouts/BaseLayout.astro";
import CodeBlock from "../components/CodeBlock.astro";
import { getOperationsGroupedByProvider, operations, getAnchorId } from "../data/operations.js";

type Operation = { group: string; name: string; desc: string; examples?: string[] };
const groupedOperations = getOperationsGroupedByProvider() as [string, Operation[]][];
const totalOperations = operations.length;

const commands = [
  { cmd: "ando", desc: "Run the build script (same as 'ando run')." },
  { cmd: "ando run", desc: "Run the build script in a Docker container." },
  { cmd: "ando verify", desc: "Check build script for errors without executing." },
  { cmd: "ando clean", desc: "Remove artifacts, temp files, and containers." },
  { cmd: "ando help", desc: "Show available commands and options." },
];

// Provider metadata for linking (sorted alphabetically)
const providerLinks: Record<string, { href: string; label: string }> = {
  Ando: { href: "/ando", label: "Ando" },
  AppService: { href: "/appservice", label: "App Service" },
  Azure: { href: "/azure", label: "Azure" },
  Bicep: { href: "/bicep", label: "Bicep" },
  Cloudflare: { href: "/cloudflare", label: "Cloudflare" },
  Dotnet: { href: "/dotnet", label: "Dotnet" },
  DotnetSdk: { href: "/dotnetsdk", label: "DotnetSdk" },
  Ef: { href: "/ef", label: "EF Core" },
  Functions: { href: "/functions", label: "Functions" },
  Node: { href: "/node", label: "Node" },
  Npm: { href: "/npm", label: "Npm" },
};

const gettingStartedCode = `# Install ANDO
dotnet tool install -g ando

# Create a hello world build script
echo 'Log.Info("Hello, World!");' > build.ando

# Run the build script
ando run`;

const exampleBuildCode = `// Project and directory references
var WebApi = DotnetProject("./src/WebApi/WebApi.csproj");
var Frontend = Directory("./frontend");

// Backend build and publish
Dotnet.Restore(WebApi);
Dotnet.Build(WebApi);
Dotnet.Test(WebApi);
Dotnet.Publish(WebApi, o => o
  .Output(Root / "artifacts" / "api"));

// Deploy backend to Azure App Service
Azure.EnsureAuthenticated();
Artifact.Zip(Root / "artifacts" / "api", Root / "artifacts" / "api.zip");
AppService.DeployWithSwap("my-webapi", Root / "artifacts" / "api.zip");

// Frontend build and deploy
Npm.Ci(Frontend);
Npm.Run(Frontend, "build");

// Deploy frontend to Cloudflare Pages
Cloudflare.EnsureAuthenticated();
Cloudflare.PagesDeploy(Frontend / "dist", "my-frontend");`;
---

<BaseLayout
  title="Build and deploy toolchain in plain C#"
  description="ANDO is a typed build and deployment system. No YAML, no DSLs, no ceremony."
>
  <section id="top" class="mb-10 md:mb-16">
    <h1 class="mb-4 max-w-4xl pt-24 text-3xl font-bold text-zinc-900 sm:mb-6 sm:text-8xl dark:text-white">
      Build and deploy with a familiar syntax
    </h1>
    <blockquote
      class="mb-18 border-l-2 border-zinc-200 pl-4 text-sm text-zinc-400 italic dark:border-zinc-700 dark:text-zinc-500"
    >
      From the Latin <span class="not-italic">"and≈ç"</span> - to set in motion.
    </blockquote>
    <p class="mb-8 font-serif text-zinc-600 sm:text-3xl dark:text-zinc-400">
      ANDO is a continous integration tool that runs your build and deployment workflow inside a Docker container. C#
      like syntax, support for .NET, Node, Npm, Cloudflare and more.
    </p>
  </section>

  <section id="getting-started" class="mb-10 md:mb-16">
    <h2 class="mb-2 text-xl font-bold text-zinc-900 sm:text-2xl dark:text-white">Getting started</h2>
    <p class="mb-4 text-zinc-500 sm:mb-6 dark:text-zinc-400">Install as a dotnet tool.</p>

    <CodeBlock code={gettingStartedCode} lang="shell" filename="shell" />
  </section>

  <section id="cli" class="mb-10 md:mb-16">
    <h2 class="mb-2 text-xl font-bold text-zinc-900 sm:text-2xl dark:text-white">ANDO commands</h2>
    <p class="mb-4 text-zinc-500 sm:mb-6 dark:text-zinc-400">The CLI provides a small, focused surface area.</p>
    <div class="overflow-x-auto">
      <table class="w-full min-w-[400px] text-sm">
        <thead>
          <tr class="border-b border-zinc-200 dark:border-zinc-700">
            <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Command</th>
            <th class="px-3 py-3 text-left text-xs font-semibold tracking-wider text-zinc-400 uppercase">Description</th
            >
          </tr>
        </thead>
        <tbody>
          {
            commands.map((item) => (
              <tr class="border-b border-zinc-100 hover:bg-zinc-50 dark:border-zinc-800 dark:hover:bg-zinc-800/50">
                <td class="px-3 py-3">
                  <code class="rounded bg-zinc-100 px-1.5 py-0.5 text-cyan-600 dark:bg-zinc-800 dark:text-cyan-400">
                    {item.cmd}
                  </code>
                </td>
                <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400">{item.desc}</td>
              </tr>
            ))
          }
        </tbody>
      </table>
    </div>
    <p class="mt-3 text-sm text-zinc-400 dark:text-zinc-500">
      See the <a href="/cli" class="text-cyan-600 hover:underline dark:text-cyan-400">CLI reference</a> for all options.
    </p>
  </section>

  <section id="build" class="mb-10 md:mb-16">
    <h2 class="mb-2 text-xl font-bold text-zinc-900 sm:text-2xl dark:text-white">Example build.ando</h2>
    <p class="mb-4 text-zinc-500 sm:mb-6 dark:text-zinc-400">
      A single C# file defines projects, tools, workflow settings, and operations.
    </p>
    <CodeBlock code={exampleBuildCode} lang="csharp" filename="build.ando" />
  </section>

  <section id="ops" class="mb-10 md:mb-16">
    <h2 class="mb-2 text-xl font-bold text-zinc-900 sm:text-2xl dark:text-white">All Operations</h2>
    <p class="mb-4 text-zinc-500 sm:mb-6 dark:text-zinc-400">
      Each operation registers a deterministic step and runs inside the container.
    </p>
    <div class="mb-4">
      <input
        type="text"
        id="ops-search"
        placeholder="Search operations..."
        class="w-full rounded-lg border border-zinc-200 bg-white px-4 py-2.5 text-sm text-zinc-800 placeholder-zinc-400 focus:border-transparent focus:ring-2 focus:ring-cyan-500 focus:outline-none sm:max-w-md dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-200 dark:placeholder-zinc-500"
      />
    </div>
    <div id="ops-container">
      {
        groupedOperations.map(([provider, ops]) => (
          <div class="ops-group mb-6" data-provider={provider}>
            <h3 class="mb-3 flex items-center gap-2 text-base font-semibold text-zinc-800 sm:text-lg dark:text-zinc-200">
              <a href={providerLinks[provider]?.href || "#"} class="hover:text-cyan-600 dark:hover:text-cyan-400">
                {providerLinks[provider]?.label || provider}
              </a>
              <span class="text-sm font-normal text-zinc-400 dark:text-zinc-500">({ops.length})</span>
            </h3>
            <div class="overflow-x-auto">
              <table class="mb-4 w-full min-w-[400px] text-sm">
                <tbody>
                  {ops.map((op) => (
                    <tr
                      data-group={op.group}
                      data-name={op.name.toLowerCase()}
                      class="ops-row border-b border-zinc-100 hover:bg-zinc-50 dark:border-zinc-800 dark:hover:bg-zinc-800/50"
                    >
                      <td class="w-1/3 px-3 py-3">
                        <a
                          href={`${providerLinks[op.group]?.href || "#"}#${getAnchorId(op.name)}`}
                          class="hover:text-cyan-600 dark:hover:text-cyan-400"
                        >
                          <code class="text-cyan-600 dark:text-cyan-400">{op.name}</code>
                        </a>
                      </td>
                      <td class="px-3 py-3 text-zinc-600 dark:text-zinc-400" set:html={op.desc} />
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        ))
      }
    </div>
    <p class="mt-3 text-sm text-zinc-400 dark:text-zinc-500" id="ops-count">{totalOperations} operations</p>
  </section>

  <script>
    // @ts-nocheck
    // Operations search functionality
    const searchInput = document.getElementById("ops-search");
    const opsContainer = document.getElementById("ops-container");
    const opsCount = document.getElementById("ops-count");
    const rows = opsContainer?.querySelectorAll(".ops-row") || [];
    const groups = opsContainer?.querySelectorAll(".ops-group") || [];
    const totalCount = rows.length;

    searchInput?.addEventListener("input", (e) => {
      const query = e.target.value.toLowerCase().trim();
      let visibleCount = 0;

      // First, filter individual rows
      rows.forEach((row) => {
        const name = row.dataset.name || "";
        const group = row.dataset.group?.toLowerCase() || "";
        const desc = row.textContent?.toLowerCase() || "";
        const matches = name.includes(query) || group.includes(query) || desc.includes(query);

        row.style.display = matches ? "" : "none";
        if (matches) visibleCount++;
      });

      // Then, hide groups that have no visible rows
      groups.forEach((group) => {
        const visibleRows = group.querySelectorAll('.ops-row:not([style*="display: none"])');
        group.style.display = visibleRows.length > 0 ? "" : "none";
      });

      if (opsCount) {
        opsCount.textContent = query ? `${visibleCount} of ${totalCount} operations` : `${totalCount} operations`;
      }
    });
  </script>
</BaseLayout>
