---
import { getHighlighter } from "../lib/highlighter";
import { markdownToHtml } from "../lib/markdown";
import { getSourceUrl } from "../data/operations";

interface Operation {
  group: string;
  name: string;
  desc: string;
  examples: string[];
  sourceFile?: string;
}

interface Props {
  operations: Operation[];
}

const { operations } = Astro.props;

// Generate anchor ID from operation name (e.g., "Cloudflare.PagesDeploy" -> "pagesdeploy")
function getAnchorId(name: string): string {
  const parts = name.split(".");
  return parts[parts.length - 1].toLowerCase();
}

// Get cached highlighter instance
const highlighter = await getHighlighter();

// Highlight code examples for an operation
function highlightExamples(examples: string[]): string {
  const code = examples.join("\n");
  return highlighter.codeToHtml(code, {
    lang: "csharp",
    themes: {
      light: "github-light",
      dark: "github-dark",
    },
    defaultColor: false,
  });
}
---

{
  operations.map((op) => (
    <section id={getAnchorId(op.name)} class="mb-8 scroll-mt-8">
      <h3 class="mb-2 flex items-center gap-3 text-lg font-semibold text-zinc-900 dark:text-white">
        <code class="text-cyan-600 dark:text-cyan-400">{op.name}</code>
        {op.sourceFile && (
          <a
            href={getSourceUrl(op.sourceFile)}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-1 rounded-md bg-zinc-100 px-2 py-0.5 text-xs font-medium text-zinc-600 transition-colors hover:bg-zinc-200 hover:text-zinc-800 dark:bg-zinc-800 dark:text-zinc-400 dark:hover:bg-zinc-700 dark:hover:text-zinc-300"
            title={`View source: ${op.sourceFile}`}
          >
            <svg class="h-3.5 w-3.5" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z" />
            </svg>
            source
          </a>
        )}
      </h3>
      <p class="mb-4 text-zinc-500 dark:text-zinc-400" set:html={markdownToHtml(op.desc)} />
      <div
        class="code-block relative overflow-x-auto rounded-xl border border-zinc-200 p-4 font-mono text-sm leading-relaxed dark:border-zinc-700"
        set:html={highlightExamples(op.examples)}
      />
    </section>
  ))
}

<style is:global>
  .code-block pre {
    margin: 0;
    background: transparent !important;
  }

  .code-block code {
    font-size: 0.875rem;
    line-height: 1.625;
  }

  /* Light theme background */
  .code-block {
    background-color: rgb(250 250 250); /* zinc-50 */
  }

  /* Dark theme background */
  .dark .code-block {
    background-color: rgb(24 24 27); /* zinc-900 */
  }

  /* Shiki dual theme: show light theme spans in light mode */
  .code-block .shiki span {
    color: var(--shiki-light);
  }

  /* Shiki dual theme: show dark theme spans in dark mode */
  .dark .code-block .shiki span {
    color: var(--shiki-dark);
  }
</style>
