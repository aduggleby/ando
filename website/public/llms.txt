# ANDO - Build and Deploy Toolchain

> ANDO is a typed build system where build scripts are written in C# and executed in Docker containers.

## Quick Start

```
dotnet tool install -g ando
echo 'Log.Info("Hello, World!");' > build.csando
ando run
```

## CLI Commands

- `ando` or `ando run` - Run the build script in a Docker container
- `ando verify` - Check build script for errors without executing
- `ando clean` - Remove artifacts, temp files, and containers
- `ando help` - Show available commands

### Run Options

- `-f, --file <file>` - Use a specific build file instead of build.csando
- `--verbosity <level>` - Set output verbosity (quiet|minimal|normal|detailed)
- `--no-color` - Disable colored output
- `--cold` - Always create a fresh container (ignore warm cache)
- `--image <image>` - Use a custom Docker image
- `--dind` - Mount Docker socket for Docker-in-Docker builds

## Key Facts

- File: `build.csando` (C# code, no .cs extension)
- Execution: All builds run in Docker containers
- No `using` statements needed - namespaces are pre-imported
- Operations register steps that execute in order

## Global Variables

| Variable | Type | Description |
|----------|------|-------------|
| Root | BuildPath | Project root directory. Supports `/` operator for paths. |
| Temp | BuildPath | Temporary files directory (root/.ando/tmp). Supports `/` operator for paths. |
| Env | Function | Get environment variable. Throws if not set by default. Use Env("NAME", required: false) to return null. |
| Dotnet | DotnetOperations | .NET CLI operations (build, test, publish). |
| Ef | EfOperations | Entity Framework Core operations. |
| Npm | NpmOperations | npm operations (install, run, ci). |
| Node | NodeInstallOperations | Node.js installation. |
| Azure | AzureOperations | Azure CLI authentication. |
| Bicep | BicepOperations | Azure Bicep deployments. |
| AppService | AppServiceOperations | Azure App Service deployments. |
| Functions | FunctionsOperations | Azure Functions deployments. |
| Cloudflare | CloudflareOperations | Cloudflare Pages deployments. |
| Nuget | NugetOperations | NuGet package operations (pack, push). |
| Ando | AndoOperations | Build configuration, artifacts, and nested builds. |
| Log | LogOperations | Logging (Info, Warning, Error, Debug). |

## Global Functions

| Function | Returns | Description |
|----------|---------|-------------|
| Directory(path?) | DirectoryRef | Create a directory reference. Defaults to "." if no path. |

## Common Patterns

### Path Operations
```csharp
var outputPath = Root / "artifacts" / "publish";
var distDir = Directory("./frontend") / "dist";
```

### .NET Build + Test + Publish
```csharp
var project = Dotnet.Project("./src/MyApp/MyApp.csproj");

Dotnet.Restore(project);
Dotnet.Build(project);
Dotnet.Test(project);
Dotnet.Publish(project, o => o.Output(Root / "artifacts"));
```

### Frontend Build
```csharp
var frontend = Directory("./frontend");

Node.Install("20");
Npm.Ci(frontend);
Npm.Run(frontend, "build");
```

### Azure Deployment
```csharp
Azure.EnsureAuthenticated();
Azure.SetSubscription("my-subscription-id");

AppService.DeployZip("my-app", Root / "artifacts" / "app.zip");
```

### Cloudflare Pages
```csharp
Cloudflare.EnsureAuthenticated();
Cloudflare.PagesDeploy(Directory("./website") / "dist", "my-project");
```

### Copy Artifacts to Host
```csharp
// Copy build outputs from container to host after build completes
Ando.CopyArtifactsToHost("dist", "./dist");

// Copy as compressed archive (faster for many small files)
Ando.CopyZippedArtifactsToHost("dist", "./output");              // Creates ./output/artifacts.tar.gz
Ando.CopyZippedArtifactsToHost("dist", "./dist/binaries.tar.gz"); // Specific .tar.gz filename
Ando.CopyZippedArtifactsToHost("dist", "./dist/binaries.zip");    // Zip format
```

### Set Docker Image
```csharp
// Use a specific Docker image for the build
Ando.UseImage("mcr.microsoft.com/dotnet/sdk:9.0");
```

### Nested Builds
```csharp
// Run a child build in a subdirectory (own container, own .env)
Ando.Build(Directory("./website"));

// Run a specific build file
Ando.Build(Directory("./website") / "deploy.csando");

// With options
Ando.Build(Directory("./api"), o => o.WithDind().ColdStart());
```

## All Operations

### Ando
- Directory(path?) - Creates a reference to a directory
- Root - The root path of the project (where build.csando is located)
- Temp - Temporary files directory (root/.ando/tmp)
- Env(name, required?) - Get environment variable. Throws if not set by default. Pass required: false to return null.
- Ando.UseImage(image) - Set the Docker image for the build container
- Ando.CopyArtifactsToHost(containerPath, hostPath) - Copy files from container to host after build
- Ando.CopyZippedArtifactsToHost(containerPath, hostPath) - Create archive and copy from container to host. Supports .tar.gz (default) and .zip. If hostPath is a directory, creates artifacts.tar.gz.
- Ando.Build(directory, options?) - Run a nested build in a subdirectory (new container, isolated context)
- Log.Info(message) - Log informational message
- Log.Warning(message) - Log warning message
- Log.Error(message) - Log error message
- Log.Debug(message) - Log debug message

### Node
- Node.Install(version?) - Install Node.js globally (default: v22)

### Dotnet
- Dotnet.SdkInstall(version?) - Install .NET SDK globally (default: 9.0). Use for base images without .NET.
- Dotnet.Project(path) - Create a .NET project reference from a .csproj path
- Dotnet.Restore(project) - Restore NuGet packages
- Dotnet.Build(project) - Compile a project
- Dotnet.Test(project) - Run unit tests
- Dotnet.Publish(project, options?) - Create deployment artifacts
- Dotnet.Tool(name, version?) - Reference a .NET CLI tool

### Ef
- Ef.DbContextFrom(project, contextName?) - Reference a DbContext
- Ef.DatabaseUpdate(context, connectionString?) - Apply pending migrations
- Ef.DatabaseUpdate(context, outputRef) - Apply migrations with connection from deployment output
- Ef.AddMigration(context, name) - Create a new migration
- Ef.Script(context, outputPath) - Generate SQL migration script
- Ef.RemoveMigration(context) - Remove the last migration

### Npm
- Npm.Install(directory) - Run npm install
- Npm.Ci(directory) - Run npm ci (clean install)
- Npm.Run(directory, script) - Run an npm script
- Npm.Test(directory) - Run npm test
- Npm.Build(directory) - Run npm run build

### Azure
- Azure.EnsureAuthenticated() - Authenticate using best available method
- Azure.EnsureLoggedIn() - Verify logged in to Azure CLI
- Azure.ShowAccount() - Display current account info
- Azure.LoginWithServicePrincipal(clientId?, secret?, tenantId?) - Login with SP
- Azure.LoginWithManagedIdentity(clientId?) - Login with managed identity
- Azure.SetSubscription(subscriptionId?) - Set active subscription
- Azure.CreateResourceGroup(name, location) - Create resource group
- Azure.DeleteResourceGroup(name) - Delete resource group

### Bicep
- Bicep.DeployToResourceGroup(rg, template, options?) - Deploy to resource group, returns BicepDeployment
- Bicep.DeployToSubscription(location, template, options?) - Deploy at subscription scope, returns BicepDeployment
- Bicep.WhatIf(rg, template, options?) - Preview deployment
- Bicep.Build(template, output?) - Compile Bicep to ARM JSON

BicepDeployment objects provide typed access to deployment outputs:
- deployment.Output("name") - Returns OutputRef that resolves at execution time
- deployment.GetOutput("name") - Gets output value directly (call during step execution)

### Cloudflare
- Cloudflare.EnsureAuthenticated() - Verify Cloudflare credentials
- Cloudflare.PagesDeploy(directory, projectName, options?) - Deploy to Pages
- Cloudflare.PagesListProjects() - List all Pages projects
- Cloudflare.PagesCreateProject(name, branch?) - Create a Pages project
- Cloudflare.PagesListDeployments(projectName?) - List deployments
- Cloudflare.PurgeCache(zoneIdOrDomain?) - Purge entire cache

### Functions
- Functions.DeployZip(name, zipPath, rg?, options?) - Deploy via zip deploy
- Functions.Publish(name, projectPath?, options?) - Publish using func CLI
- Functions.DeployWithSwap(name, zipPath, slot?, rg?) - Deploy then swap
- Functions.SwapSlots(name, sourceSlot, rg?, targetSlot?) - Swap slots
- Functions.Restart(name, rg?, slot?) - Restart function app
- Functions.Start(name, rg?, slot?) - Start function app
- Functions.Stop(name, rg?, slot?) - Stop function app

### AppService
- AppService.DeployZip(name, zipPath, rg?, options?) - Deploy via zip deploy
- AppService.DeployWithSwap(name, zipPath, slot?, rg?) - Deploy then swap
- AppService.SwapSlots(name, sourceSlot, rg?, targetSlot?) - Swap slots
- AppService.CreateSlot(name, slotName, rg?, configSource?) - Create slot
- AppService.DeleteSlot(name, slotName, rg?) - Delete slot
- AppService.ListSlots(name, rg?) - List deployment slots
- AppService.Restart(name, rg?, slot?) - Restart app service
- AppService.Start(name, rg?, slot?) - Start app service
- AppService.Stop(name, rg?, slot?) - Stop app service

### Nuget
- Nuget.EnsureAuthenticated() - Ensure API key is available (prompts if NUGET_API_KEY not set)
- Nuget.Pack(project, options?) - Create NuGet package (default: Release config, outputs to bin/Release)
- Nuget.Push(project, options?) - Push packages from bin/Release/*.nupkg (default: nuget.org, skips duplicates)
- Nuget.Push(path, options?) - Push package from path/glob (default: nuget.org, skips duplicates)

## Tips for Writing Build Scripts

1. Build scripts are C# - use C# syntax including var, lambdas, string interpolation
2. No semicolons needed at end of lines (but they work if included)
3. Operations execute in the order they are called
4. Use Dotnet.Project() for .csproj files, Directory() for folders
5. The `/` operator concatenates paths: Root / "src" / "app"
6. Options are configured via fluent lambdas: o => o.Output(...).WithRuntime(...)
7. Always call EnsureAuthenticated() before cloud operations
8. Use `ando verify` to check scripts without executing
