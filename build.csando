// =============================================================================
// build.csando - ANDO CLI Build and Release Script
//
// Profiles:
// - (default): Build, test, publish executables, create NuGet package
// - publish: Also pushes to NuGet.org, container registry, creates GitHub release with binaries, and deploys docs
// - docs: Deploy the documentation website to Cloudflare (run `ando docs` first to generate API docs)
// - e2e: Force E2E tests to run (even on Ando.Server)
//
// Usage:
//   ando                 # Build and test (E2E tests run locally, skipped on server)
//   ando -p publish      # Build, test, and push to NuGet.org + container registry + deploy docs
//   ando docs            # Generate API docs (pre-hook) + update docs with Claude
//   ando -p docs         # Deploy docs to Cloudflare (skips build/test)
//   ando -p e2e          # Force E2E tests to run
//   ando -p publish,e2e  # Publish profile with forced E2E tests
//
// E2E Tests:
//   E2E tests use docker-compose to spin up SQL Server and web server containers.
//   When running locally, tests run automatically. On Ando.Server, they're skipped
//   by default (use -p e2e to override) because the server environment may not
//   support nested container orchestration.
//
// Prerequisites:
// - NUGET_API_KEY env var set (or enter when prompted) for publish profile
// - Run `ando bump` before publish to set the desired version
// - Run `ando docs` before publish/docs profile to generate API documentation
// - For E2E tests: Run with `ando --dind` to enable Docker-in-Docker
//
// Output:
// - dist/{runtime}/ando[.exe] - Platform-specific executables
// - dist/packages/*.nupkg     - NuGet package for dotnet tool install
// - ando-server:{version}     - Docker image (publish profile only)
// =============================================================================

// Define profiles
var publish = DefineProfile("publish");
var docs = DefineProfile("docs");
var e2e = DefineProfile("e2e");

// Docs-only profile: just deploy the website and exit early
if (docs && !publish)
{
    Log.Info("Deploying documentation website to Cloudflare...");
    Ando.Build(Directory("./website"), o => o.WithProfile("publish"));
    return;
}

// Detect if running on Ando.Server (vs local ando CLI)
// ANDO_HOST_ROOT is only set when running on Ando.Server
var isOnServer = Env("ANDO_HOST_ROOT", required: false) != null;

var project = Dotnet.Project("./src/Ando/Ando.csproj");
// Included so `ando bump` (and therefore `ando release`) keeps the server assembly version in sync.
// We don't build/publish the server here directly; the Docker build handles that.
var serverProject = Dotnet.Project("./src/Ando.Server/Ando.Server.csproj");
var testProject = Dotnet.Project("./tests/Ando.Tests/Ando.Tests.csproj");

// Get version from the project file.
var version = project.Version;
Log.Info($"Building version: {version}");

// Base output directory
var distPath = Root / "dist";

// Install .NET SDK
Dotnet.SdkInstall();

// Restore dependencies
Dotnet.Restore(project);

// Build the project
Dotnet.Build(project);

// Run .NET tests (exclude E2E - they have a separate step below)
Dotnet.Test(testProject, o => o.Filter = "Category!=E2E");

// =============================================================================
// E2E Tests (Playwright)
//
// E2E tests use docker-compose to spin up SQL Server and web server containers.
// The tests connect via host.docker.internal when running inside an ANDO container.
//
// - Locally: Run automatically if Docker available (detected via absence of ANDO_HOST_ROOT)
// - On Ando.Server: Skipped by default (use -p e2e to force)
//
// IMPORTANT: Run with `ando --dind` to enable Docker-in-Docker mode.
// This gives the build container access to the host's Docker daemon.
// =============================================================================
var e2eTests = Directory("./tests/Ando.Server.E2E");

// Check if we should run E2E tests
var shouldRunE2E = !isOnServer || e2e;

if (shouldRunE2E)
{
    // Check if Docker is available (requires --dind flag when running ando)
    if (!Docker.IsAvailable())
    {
        Log.Warning("Skipping E2E tests (Docker not available - run with 'ando --dind' to enable)");
    }
    else
    {
        Log.Info("Running Playwright E2E tests...");

        // Install Docker CLI (needed for docker-compose)
        Docker.Install();

        // Install npm dependencies
        Npm.Ci(e2eTests);

        // Install Playwright browsers
        Playwright.Install(e2eTests);

        // Run E2E tests
        // Exit code propagates - test failures will fail the build
        Playwright.Test(e2eTests);
    }
}
else
{
    Log.Info("Skipping E2E tests (running on Ando.Server - use -p e2e to override)");
}

// Publish for multiple platforms
var runtimes = new[] { "win-x64", "win-arm64", "linux-x64", "linux-arm64", "osx-x64", "osx-arm64" };

foreach (var runtime in runtimes)
{
    Log.Info($"Publishing for {runtime}...");
    var outputDir = distPath / runtime;

    Dotnet.Publish(project, o => o
        .WithRuntime(runtime)
        .Output(outputDir)
        .AsSelfContained()
        .AsSingleFile());
}

// Create NuGet package for the dotnet tool
Nuget.Pack(project);

// Push to NuGet.org, container registry, and deploy website (only with publish profile)
if (publish)
{
    // Push to NuGet (skip if version already exists)
    Nuget.EnsureAuthenticated();
    Nuget.Push(project, o => o.SkipDuplicates());

    // Install Docker CLI (needed for --dind mode)
    Docker.Install();

    // Build multi-arch image and push to ghcr.io in one atomic operation.
    // Using WithPush() ensures both version and latest tags point to the same manifest,
    // avoiding cache staleness issues that can occur with separate build/push steps.
    Log.Info("Building and pushing Docker image...");
    Docker.Build("./src/Ando.Server/Dockerfile", o => o
        .WithPlatforms("linux/amd64", "linux/arm64")
        .WithTag($"ghcr.io/aduggleby/ando-server:{version}")
        .WithTag("ghcr.io/aduggleby/ando-server:latest")
        .WithContext(".")
        .WithPush());

    // Tag git repo with version (skip if already exists)
    Git.Tag($"v{version}", o => o.WithSkipIfExists());
    Git.Push();
    Git.PushTags();

    // Create GitHub release with binaries
    // Files are renamed during upload using path#newname syntax for display labels
    // The actual filename comes from the path - unique directory names ensure unique uploads
    GitHub.CreateRelease(o => o
        .WithTag(version)
        .WithGeneratedNotes()
        .WithFiles(
            "./dist/win-x64/ando.exe",
            "./dist/win-arm64/ando.exe",
            "./dist/linux-x64/ando",
            "./dist/linux-arm64/ando",
            "./dist/osx-x64/ando",
            "./dist/osx-arm64/ando"
        ));

		// Build and deploy the documentation website
		// API docs are generated via `ando docs` pre-hook
		Ando.Build(Directory("./website"), o => o.WithProfile("publish"));
	}

// Copy the dist folder from container to host both individually and as a compressed archive
Ando.CopyArtifactsToHost("dist", "./dist");
Ando.CopyZippedArtifactsToHost("dist", "./dist/ando-binaries.zip");
